<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Chanel x Pulp Fiction Experience</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.85);
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      font-size: 11px;
      z-index: 1000;
      max-width: 280px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #0f0;
    }

    #instructions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 15px 30px;
      font-family: 'Helvetica Neue', sans-serif;
      font-size: 14px;
      border-radius: 0;
      border: 1px solid #FFD700;
      z-index: 1000;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    #title {
      position: fixed;
      top: 10px;
      right: 10px;
      color: #FFD700;
      font-family: 'Georgia', serif;
      font-size: 18px;
      font-style: italic;
      z-index: 1000;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    #controls {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #aaa;
      padding: 8px 15px;
      font-family: monospace;
      font-size: 11px;
      z-index: 1000;
    }

    #start-experience {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      cursor: pointer;
    }

    #start-experience h1 {
      color: #FFD700;
      font-family: 'Georgia', serif;
      font-size: 48px;
      font-style: italic;
      margin-bottom: 20px;
      text-shadow: 2px 2px 8px rgba(255, 215, 0, 0.5);
    }

    #start-experience p {
      color: #fff;
      font-family: 'Helvetica Neue', sans-serif;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 3px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
  </style>
</head>

<body>
  <div id="start-experience">
    <h1>CHANEL √ó Pulp Fiction</h1>
    <p>Cliquez pour entrer</p>
  </div>

  <div id="debug">Initialisation...</div>
  <div id="controls">ZQSD / ‚Üê‚Üë‚Üì‚Üí : se d√©placer ‚Ä¢ Souris : regarder ‚Ä¢ VR : G√¢chette pour interagir</div>
  <div id="instructions">Cliquez sur le $5 Shake</div>
  <div id="title">CHANEL √ó Pulp Fiction</div>

  <audio id="twist-music" loop preload="auto">
    <source src="./assets/song/You Never Can Tell.mp3" type="audio/mpeg">
  </audio>

  <audio id="gun-sound" preload="auto">
    <source src="./assets/song/gun-sound.mp3" type="audio/mpeg">
  </audio>

  <a-scene vr-mode-ui="enabled: true">

    <a-assets>
      <a-asset-item id="couch-model" src="./assets/models/Couch.glb"></a-asset-item>
      <a-asset-item id="milkshake-model" src="./assets/models/Milkshake.glb"></a-asset-item>
      <a-asset-item id="speaker-model" src="./assets/models/Speaker.glb"></a-asset-item>
      <a-asset-item id="kitchen-bar-model" src="./assets/models/Kitchen_Bar.glb"></a-asset-item>
      <a-asset-item id="bottle1" src="./assets/models/bottle1.glb"></a-asset-item>
      <a-asset-item id="glass1" src="./assets/models/glass1.glb"></a-asset-item>
      <a-asset-item id="glass2" src="./assets/models/glass2.glb"></a-asset-item>
      <a-asset-item id="blood-model" src="./assets/models/Blood.glb"></a-asset-item>
      <a-asset-item id="pistol-model" src="./assets/models/pistol.glb"></a-asset-item>
      <a-asset-item id="valise-model" src="./assets/models/valise.glb"></a-asset-item>
      <a-asset-item id="golden-key-model" src="./assets/models/the_golden_key.glb"></a-asset-item>
    </a-assets>

    <!-- CAMERA RIG -->
    <a-entity id="rig" position="0 0 0" wasd-controls="acceleration: 20"
      constrain-position="min: -1.7 0 -1.7; max: 1.7 0 1.7">

      <a-camera id="cam" position="0 1.6 0" look-controls="enabled: true; pointerLockEnabled: true">
        <a-entity id="desktop-cursor" cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable; far: 10">
          <a-ring position="0 0 -1" radius-inner="0.02" radius-outer="0.03" color="#FFD700" opacity="0.8"
            animation__scale="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dur: 500; dir: alternate; loop: true">
          </a-ring>
        </a-entity>

        <a-plane id="black-out" position="0 0 -0.3" width="6" height="6"
          material="color: #000; opacity: 0; transparent: true; shader: flat; side: double" visible="false">
        </a-plane>

        <!-- ========== √âCRAN FINAL CHANEL (fix√© √† la cam√©ra) ========== -->
        <a-entity id="chanel-screen" visible="false" position="0 0 -2">
          
          <!-- Fond blanc -->
          <a-plane width="4" height="3" 
                   material="color: #FFFFFF; shader: flat">
          </a-plane>
          
          <!-- Logo CHANEL -->
          <a-text id="chanel-logo" 
                  value="CHANEL" 
                  position="0 0.5 0.01" 
                  align="center" 
                  color="#000000"
                  scale="1.2 1.2 1.2"
                  width="4">
          </a-text>
          
          <!-- Sous-titre -->
          <a-text id="chanel-subtitle" 
                  value="The Golden Key" 
                  position="0 0 0.01" 
                  align="center" 
                  color="#666666"
                  scale="0.5 0.5 0.5"
                  width="4">
          </a-text>
          
          <!-- Bouton Recommencer -->
          <a-entity id="restart-button" position="0 -0.6 0.01">
            <!-- Fond du bouton -->
            <a-plane id="restart-btn-bg" 
                     width="1.2" height="0.25"
                     material="color: #000000; shader: flat">
            </a-plane>
            <!-- Texte du bouton -->
            <a-text value="RECOMMENCER" 
                    position="0 0 0.01" 
                    align="center" 
                    color="#FFFFFF"
                    scale="0.4 0.4 0.4"
                    width="3">
            </a-text>
            <!-- Hitbox pour le clic -->
            <a-box id="restart-hitbox"
                   class="clickable"
                   position="0 0 0.05"
                   width="1.4" height="0.4" depth="0.2"
                   material="opacity: 0.001; transparent: true; side: double"></a-box>
          </a-entity>
          
        </a-entity>

      </a-camera>

      <a-entity id="left-hand" laser-controls="hand: left; model: true; defaultModelColor: #FFD700"
        raycaster="objects: .clickable; far: 10; lineColor: #FFD700; lineOpacity: 0.5" vr-click-handler>
      </a-entity>

      <a-entity id="right-hand" laser-controls="hand: right; model: true; defaultModelColor: #FFD700"
        raycaster="objects: .clickable; far: 10; lineColor: #FFD700; lineOpacity: 0.5" vr-click-handler>
      </a-entity>

    </a-entity>

    <!-- Cube 4x4x4 -->
    <a-box id="room" position="0 2 0" width="4" height="4" depth="4"
      material="color: #1a0a0a; metalness: 0.3; roughness: 0.7; side: back"></a-box>

    <!-- Sol -->
    <a-plane id="floor" position="0 0.01 0" rotation="-90 0 0" width="4" height="4"
      material="color: #111; metalness: 0.5; roughness: 0.5"></a-plane>

    <!-- ========== SC√àNE A ========== -->
    <a-entity id="scene-a">

      <!-- DANCEFLOOR -->
      <a-entity id="dancefloor" position="0 0.02 0">
        <a-box position="-0.75 0 -0.75" width="0.5" height="0.02" depth="0.5" color="#111"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="-0.25 0 -0.75" width="0.5" height="0.02" depth="0.5" color="#EEE"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="0.25 0 -0.75" width="0.5" height="0.02" depth="0.5" color="#111"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="0.75 0 -0.75" width="0.5" height="0.02" depth="0.5" color="#EEE"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="-0.75 0 -0.25" width="0.5" height="0.02" depth="0.5" color="#EEE"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="-0.25 0 -0.25" width="0.5" height="0.02" depth="0.5" color="#111"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="0.25 0 -0.25" width="0.5" height="0.02" depth="0.5" color="#EEE"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="0.75 0 -0.25" width="0.5" height="0.02" depth="0.5" color="#111"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="-0.75 0 0.25" width="0.5" height="0.02" depth="0.5" color="#111"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="-0.25 0 0.25" width="0.5" height="0.02" depth="0.5" color="#EEE"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="0.25 0 0.25" width="0.5" height="0.02" depth="0.5" color="#111"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="0.75 0 0.25" width="0.5" height="0.02" depth="0.5" color="#EEE"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="-0.75 0 0.75" width="0.5" height="0.02" depth="0.5" color="#EEE"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="-0.25 0 0.75" width="0.5" height="0.02" depth="0.5" color="#111"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="0.25 0 0.75" width="0.5" height="0.02" depth="0.5" color="#EEE"
          material="metalness: 0.8; roughness: 0.2"></a-box>
        <a-box position="0.75 0 0.75" width="0.5" height="0.02" depth="0.5" color="#111"
          material="metalness: 0.8; roughness: 0.2"></a-box>
      </a-entity>

      <!-- COUCHS -->
      <a-entity gltf-model="#couch-model" position="-1.6 0.3 0" rotation="0 -90 0" scale="1.6 1.6 1.6"></a-entity>
      <a-entity gltf-model="#couch-model" position="1.6 0.3 0" rotation="0 90 0" scale="1.6 1.6 1.6"></a-entity>

      <!-- SPEAKERS -->
      <a-entity gltf-model="#speaker-model" position="-1.5 0 -1.5" rotation="0 45 0" scale="0.5 0.5 0.5"></a-entity>
      <a-entity gltf-model="#speaker-model" position="1.5 0 -1.5" rotation="0 -45 0" scale="1 1 1"></a-entity>

      <!-- KITCHEN BAR -->
      <a-entity id="bar" position="-0.3 0 0.4" scale="1.5 1.5 1.5">
        <a-entity gltf-model="#kitchen-bar-model" position="0 0 -1.3" rotation="0 0 0" scale="1.2 2 1.2"></a-entity>
        <a-entity gltf-model="#kitchen-bar-model" position="0.5 0 -1.3" rotation="0 0 0" scale="1.2 2 1.2"></a-entity>
        <a-entity gltf-model="#kitchen-bar-model" position="1 0 -1.3" rotation="0 0 0" scale="1.2 2 1.2"></a-entity>
        <a-entity gltf-model="#kitchen-bar-model" position="0.747 0 -1.802" rotation="0 90 0"
          scale="1.2 2 1.2"></a-entity>
        <a-entity gltf-model="#glass1" position="0.870 1 -1.300" rotation="0 0 0" scale="0.2 0.2 0.2"></a-entity>
        <a-entity gltf-model="#glass1" position="-0.415 1 -1.149" rotation="0 0 0" scale="0.2 0.2 0.2"></a-entity>
        <a-entity gltf-model="#glass2" position="0.071 0.850 -1.136" rotation="0 0 0" scale="0.1 0.1 0.1"></a-entity>
      </a-entity>

      <!-- FLAQUE DE SANG AVEC PISTOLET -->
      <a-entity position="0.5 0 -0.8">
        <a-entity id="blood" gltf-model="#blood-model" position="0 0.038 1.778" rotation="0 0 0"
          scale="0.6 0.6 0.6"></a-entity>
        <a-entity id="pistol" gltf-model="#pistol-model" position="0 0.057 1.536" rotation="90 45 0"
          scale="0.1 0.1 0.1"></a-entity>
        <a-light type="point" intensity="0.4" distance="2" color="#FF6347" position="0 0.2 0"></a-light>
      </a-entity>

      <!-- TABLE -->
      <a-entity position="0 0 1.2">
        <a-cylinder radius="0.35" height="0.05" position="0 0.55 0" color="#222"
          material="metalness: 0.9; roughness: 0.1"></a-cylinder>
        <a-cylinder radius="0.04" height="0.55" position="0 0.275 0" color="#888"
          material="metalness: 0.9; roughness: 0.1"></a-cylinder>
      </a-entity>

      <!-- MILKSHAKE -->
      <a-entity id="trigger-milkshake" position="0 0.58 1.2">
        <a-entity id="milkshake-glb" gltf-model="#milkshake-model" position="0 0.2 0" scale="0.13 0.13 0.13"></a-entity>
        <a-light type="point" intensity="0.8" distance="2" color="#FFB6C1"></a-light>
      </a-entity>

      <!-- HITBOX -->
      <a-box id="milkshake-hitbox" class="clickable" position="0 0.9 1.15" width="1.0" height="1.2" depth="1.0"
        material="opacity: 0.001; transparent: true; side: double; depthTest: false"></a-box>

      <!-- N√âONS PLAFOND -->
      <a-entity position="0 3.95 -1.8">
        <a-box width="3.8" height="0.05" depth="0.05"
          material="color: #FF1493; emissive: #FF1493; emissiveIntensity: 3; shader: flat"></a-box>
        <a-light type="point" intensity="1.2" distance="4" color="#FF1493" position="0 0 0"></a-light>
        <a-light type="point" intensity="0.8" distance="3" color="#FF1493" position="-1.5 0 0"></a-light>
        <a-light type="point" intensity="0.8" distance="3" color="#FF1493" position="1.5 0 0"></a-light>
      </a-entity>

      <a-entity position="0 3.95 1.8">
        <a-box width="3.8" height="0.05" depth="0.05"
          material="color: #00CED1; emissive: #00CED1; emissiveIntensity: 3; shader: flat"></a-box>
        <a-light type="point" intensity="1.2" distance="4" color="#00CED1" position="0 0 0"></a-light>
        <a-light type="point" intensity="0.8" distance="3" color="#00CED1" position="-1.5 0 0"></a-light>
        <a-light type="point" intensity="0.8" distance="3" color="#00CED1" position="1.5 0 0"></a-light>
      </a-entity>

      <!-- N√âONS TEXTE -->
      <a-entity position="0 2.5 -1.95">
        <a-text value="JACK RABBIT SLIM'S" align="center" color="#FF1493" scale="0.35 0.35 0.35"></a-text>
        <a-light type="point" intensity="0.8" distance="3" color="#FF1493" position="0 0 0.1"></a-light>
      </a-entity>

      <!-- PANNEAU VR -->
      <a-entity id="vr-help" position="0 2 1.5" rotation="0 180 0" visible="false">
        <a-plane width="1.2" height="0.4" color="#000" opacity="0.8"></a-plane>
        <a-text value="Pointez le milkshake\net appuyez sur la gachette" position="0 0 0.01" align="center"
          color="#FFD700" scale="0.4 0.4 0.4" width="2.5"></a-text>
      </a-entity>

      <!-- √âCLAIRAGE SC√àNE A -->
      <a-light type="ambient" color="#331111" intensity="0.4"></a-light>
      <a-light type="spot" position="0 3.9 0" rotation="-90 0 0" intensity="1.5" color="#FFFAF0" angle="50"
        penumbra="0.3"></a-light>
      <a-light type="point" position="-1.5 3 -1" intensity="0.6" color="#FF1493" distance="4"></a-light>
      <a-light type="point" position="1.5 3 -1" intensity="0.6" color="#00CED1" distance="4"></a-light>
      <a-light type="point" position="0 3 1.5" intensity="0.4" color="#FFD700" distance="3"></a-light>
    </a-entity>

    <!-- ========== SC√àNE B : LES MALLETTES PULP FICTION ========== -->
    <a-entity id="scene-b" visible="false">

      <!-- ====== MALLETTE 1 : PISTOLET (gauche) ====== -->
      <a-entity id="briefcase-1" position="-0.6 0 -0.8">
        <!-- Pi√©destal -->
        <a-cylinder radius="0.4" height="0.06" position="0 0.03 0"
          material="color: #1a1a1a; metalness: 0.9; roughness: 0.1"></a-cylinder>
        <a-cylinder radius="0.12" height="0.45" position="0 0.28 0"
          material="color: #111; metalness: 0.8; roughness: 0.2"></a-cylinder>
        <a-cylinder radius="0.35" height="0.04" position="0 0.52 0"
          material="color: #1a1a1a; metalness: 0.9; roughness: 0.1"></a-cylinder>
        
        <!-- Mallette -->
        <a-entity id="mallette" gltf-model="#valise-model" position="0 0.61 0" rotation="0 125 0" scale="0.35 0.35 0.35"></a-entity>
        
        <!-- Lumi√®re mallette -->
        <a-light type="point" intensity="6" color="#FFD700" position="0 0.9 0" distance="3"
          animation__pulse="property: intensity; from: 4; to: 8; dur: 2000; dir: alternate; loop: true; easing: easeInOutSine"></a-light>
      </a-entity>

      <!-- PISTOLET INTERACTIF (mallette 1) -->
      <a-entity id="pistol-container" position="-0.6 0.6 -0.8">
        <a-entity id="pistol-model-b" 
                  gltf-model="#pistol-model" 
                  position="0 0 0" 
                  rotation="90 -215.700 0"
                  scale="0.08 0.08 0.08">
        </a-entity>
        <!-- Hitbox TR√àS GRANDE pour clic facile -->
        <a-box id="pistol-hitbox" 
               class="clickable" 
               position="0 0.2 0.1" 
               width="1.0" height="0.8" depth="1.0"
               material="opacity: 0.001; transparent: true; side: double; depthTest: false"></a-box>
        <a-light id="pistol-light" type="point" intensity="0.3" distance="1" color="#FF4444" position="0 0.05 0"></a-light>
      </a-entity>

      <!-- ====== MALLETTE 2 : CL√â DOR√âE (droite) ====== -->
      <a-entity id="briefcase-2" position="0.6 0 -0.8">
        <!-- Pi√©destal -->
        <a-cylinder radius="0.4" height="0.06" position="0 0.03 0"
          material="color: #1a1a1a; metalness: 0.9; roughness: 0.1"></a-cylinder>
        <a-cylinder radius="0.12" height="0.45" position="0 0.28 0"
          material="color: #111; metalness: 0.8; roughness: 0.2"></a-cylinder>
        <a-cylinder radius="0.35" height="0.04" position="0 0.52 0"
          material="color: #1a1a1a; metalness: 0.9; roughness: 0.1"></a-cylinder>
        
        <!-- Mallette -->
        <a-entity id="mallette2" gltf-model="#valise-model" position="0 0.61 0" rotation="0 100 0" scale="0.35 0.35 0.35"></a-entity>
        
        <!-- Lumi√®re mallette -->
        <a-light type="point" intensity="6" color="#FFFFFF" position="0 0.9 0" distance="3"
          animation__pulse2="property: intensity; from: 4; to: 8; dur: 2500; dir: alternate; loop: true; easing: easeInOutSine"></a-light>
      </a-entity>

      <!-- CL√â DOR√âE INTERACTIVE (mallette 2) -->
      <a-entity id="key-container" position="0.7 0.6 -0.8">
        <a-entity id="key-model" 
                  gltf-model="#golden-key-model" 
                  position="0 0 0" 
                  rotation="90 0 0"
                  scale="0.0005 0.0005 0.0005">
        </a-entity>
        <!-- Hitbox TR√àS GRANDE pour clic facile -->
        <a-box id="key-hitbox" 
               class="clickable" 
               position="0 0.2 0.1" 
               width="1.0" height="0.8" depth="1.0"
               material="opacity: 0.001; transparent: true; side: double; depthTest: false"></a-box>
        <a-light id="key-light" type="point" intensity="0.5" distance="1.5" color="#FFD700" position="0 0.05 0"></a-light>
      </a-entity>

      <!-- √âCLAIRAGE ROUGE DIFFUS PULP FICTION -->
      <a-light type="ambient" color="#330000" intensity="0.3"></a-light>

      <!-- Spots rouges diffus -->
      <a-light type="point" color="#8B0000" intensity="0.8" distance="5" position="-1.8 2 0"></a-light>
      <a-light type="point" color="#8B0000" intensity="0.8" distance="5" position="1.8 2 0"></a-light>
      <a-light type="point" color="#660000" intensity="0.6" distance="4" position="0 2 1.8"></a-light>
      <a-light type="point" color="#660000" intensity="0.6" distance="4" position="0 2 -1.8"></a-light>

      <!-- Spots sur les mallettes -->
      <a-light type="spot" color="#FFFAF0" intensity="1.2" distance="4" angle="30" penumbra="0.5"
        position="-0.6 3.5 -0.5"></a-light>
      <a-light type="spot" color="#FFFAF0" intensity="1.2" distance="4" angle="30" penumbra="0.5"
        position="0.6 3.5 -0.5"></a-light>

      <!-- Lueur rouge au sol -->
      <a-light type="point" color="#8B0000" intensity="0.5" distance="3" position="0 0.1 0"></a-light>

      <!-- Halo rouge plafond -->
      <a-light type="point" color="#4A0000" intensity="0.4" distance="4" position="0 3.9 0"></a-light>

      <!-- Texte myst√®re -->
      <a-text id="mystery-text" value="Choose your way" position="0 2.5 -1.5" align="center" color="#FFD700"
        scale="0.6 0.6 0.6" opacity="0"
        animation__float="property: position; from: 0 2.5 -1.5; to: 0 2.55 -1.5; dur: 2000; dir: alternate; loop: true">
      </a-text>

      <!-- Particules dor√©es -->
      <a-entity position="0 1.5 -0.8">
        <a-sphere radius="0.01" position="0.2 0.3 0.1" material="color: #FFD700; opacity: 0.3; transparent: true"
          animation__float1="property: position; to: 0.25 0.5 0.15; dur: 4000; dir: alternate; loop: true"></a-sphere>
        <a-sphere radius="0.008" position="-0.15 0.2 -0.1" material="color: #FFD700; opacity: 0.2; transparent: true"
          animation__float2="property: position; to: -0.1 0.4 -0.05; dur: 3500; dir: alternate; loop: true"></a-sphere>
        <a-sphere radius="0.012" position="0.1 0.4 0.05" material="color: #FFD700; opacity: 0.25; transparent: true"
          animation__float3="property: position; to: 0.05 0.6 0.1; dur: 4500; dir: alternate; loop: true"></a-sphere>
        <a-sphere radius="0.009" position="-0.3 0.35 0.2" material="color: #FFD700; opacity: 0.2; transparent: true"
          animation__float4="property: position; to: -0.25 0.55 0.25; dur: 3800; dir: alternate; loop: true"></a-sphere>
      </a-entity>

    </a-entity>

  </a-scene>

  <script>
    const music = document.getElementById('twist-music');
    const gunSound = document.getElementById('gun-sound');
    const musicVolume = 0.3;
    
    // Variables d'√©tat globales pour permettre le reset
    let globalTransitionDone = false;
    let globalPistolActivated = false;
    let globalKeyActivated = false;

    function fadeOutMusic(duration = 1500) {
      console.log('üéµ fadeOutMusic appel√©, music.paused:', music.paused, 'volume:', music.volume);

      if (!music || music.paused) {
        console.log('üéµ Musique d√©j√† en pause ou non trouv√©e');
        return;
      }

      const startVolume = music.volume;
      const startTime = Date.now();

      function fade() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        music.volume = startVolume * Math.pow(1 - progress, 2);

        if (progress < 1) {
          requestAnimationFrame(fade);
        } else {
          music.pause();
          music.volume = 0;
          console.log('üéµ Musique arr√™t√©e');
          updateDebug('üéµ Musique arr√™t√©e');
        }
      }
      fade();
    }

    document.getElementById('start-experience').addEventListener('click', () => {
      document.getElementById('start-experience').style.display = 'none';
      music.volume = musicVolume;
      music.play().then(() => {
        console.log('üéµ Musique lanc√©e avec succ√®s');
        updateDebug('üéµ ‚ô™ You Never Can Tell ‚ô™');
      }).catch(err => {
        console.warn('Audio bloqu√©:', err);
        updateDebug('‚ö†Ô∏è Audio bloqu√©');
      });
    });

    // Fonction de reset compl√®te (utilis√©e par le bouton VR)
    function resetExperience() {
      // Rafra√Æchir la page pour tout r√©initialiser proprement
      location.reload();
    }

    AFRAME.registerComponent('vr-click-handler', {
      init: function () {
        const el = this.el;
        el.addEventListener('triggerdown', this.onClick.bind(this));
        el.addEventListener('selectstart', this.onClick.bind(this));
        el.addEventListener('raycaster-intersection', (evt) => {
          const target = evt.detail.els[0];
          if (target && target.classList.contains('clickable')) {
            el.setAttribute('raycaster', 'lineColor', '#00FF00');
          }
        });
        el.addEventListener('raycaster-intersection-cleared', () => {
          el.setAttribute('raycaster', 'lineColor', '#FFD700');
        });
      },
      onClick: function () {
        const raycaster = this.el.components.raycaster;
        if (!raycaster) return;
        const intersections = raycaster.intersections;
        if (intersections.length > 0) {
          const target = intersections[0].object.el;
          if (target && target.classList.contains('clickable')) {
            target.emit('click');
          }
        }
      }
    });

    AFRAME.registerComponent('constrain-position', {
      schema: {
        min: { type: 'vec3', default: { x: -1.7, y: 0, z: -1.7 } },
        max: { type: 'vec3', default: { x: 1.7, y: 0, z: 1.7 } }
      },
      tick: function () {
        const pos = this.el.object3D.position;
        const min = this.data.min;
        const max = this.data.max;
        if (pos.x < min.x) pos.x = min.x;
        if (pos.x > max.x) pos.x = max.x;
        if (pos.z < min.z) pos.z = min.z;
        if (pos.z > max.z) pos.z = max.z;
        pos.y = 0;
      }
    });

    function updateDebug(msg) {
      const d = document.getElementById('debug');
      if (d) { d.innerHTML += `<br>${msg}`; d.scrollTop = d.scrollHeight; }
      console.log(msg);
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateDebug('üé¨ Chanel x Pulp Fiction');
      updateDebug('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

      const scene = document.querySelector('a-scene');

      scene.addEventListener('loaded', () => {
        updateDebug('‚úÖ Sc√®ne charg√©e');
        updateDebug('üéÆ Desktop: ZQSD + clic');
        updateDebug('ü•Ω VR: G√¢chette');

        const milkshakeHitbox = document.querySelector('#milkshake-hitbox');
        const desktopCursor = document.querySelector('#desktop-cursor');
        const blackOut = document.querySelector('#black-out');
        const sceneA = document.querySelector('#scene-a');
        const sceneB = document.querySelector('#scene-b');
        const room = document.querySelector('#room');
        const floor = document.querySelector('#floor');
        const instructions = document.getElementById('instructions');
        const controls = document.getElementById('controls');
        const mysteryText = document.querySelector('#mystery-text');
        const vrHelp = document.querySelector('#vr-help');

        function transitionToSceneB() {
          if (globalTransitionDone) return;
          globalTransitionDone = true;
          updateDebug('üéûÔ∏è CUT !');

          console.log('üéµ √âtat musique avant fondu - paused:', music.paused, 'volume:', music.volume);
          updateDebug('üéµ Fondu musical...');

          fadeOutMusic(1500);

          if (instructions) instructions.innerHTML = 'THE MYSTERY';
          if (controls) controls.style.display = 'none';
          milkshakeHitbox.classList.remove('clickable');

          blackOut.setAttribute('visible', 'true');
          blackOut.setAttribute('animation__fadeIn', {
            property: 'material.opacity', from: 0, to: 1, dur: 200, easing: 'easeInQuad'
          });

          setTimeout(() => {
            sceneA.setAttribute('visible', 'false');
            sceneB.setAttribute('visible', 'true');

            room.setAttribute('material', {
              color: '#1a0505',
              metalness: 0.3,
              roughness: 0.8,
              side: 'back'
            });

            floor.setAttribute('material', {
              color: '#0a0a0a',
              metalness: 0.7,
              roughness: 0.3
            });

            document.querySelector('#rig').object3D.position.set(0, 0, 1.2);

            setTimeout(() => {
              blackOut.setAttribute('animation__fadeOut', {
                property: 'material.opacity', from: 1, to: 0, dur: 2000, easing: 'easeOutCubic'
              });
              setTimeout(() => {
                mysteryText.setAttribute('animation__appear', {
                  property: 'opacity', from: 0, to: 1, dur: 2500, easing: 'easeOutQuad'
                });
              }, 1000);
              setTimeout(() => {
                blackOut.setAttribute('visible', 'false');
                updateDebug('‚úÖ R√©v√©lation');
                updateDebug('üíº Les Mallettes...');
                updateDebug('üî´ Cliquez sur le pistolet');
                updateDebug('üîë Cliquez sur la cl√©');
              }, 2100);
            }, 200);
          }, 300);
        }

        // ====== PISTOLET INTERACTIF - SC√àNE B ======
        function activatePistol() {
          if (globalPistolActivated) return;
          globalPistolActivated = true;
          
          updateDebug('üî´ Pistolet activ√© !');
          
          const pistolContainer = document.querySelector('#pistol-container');
          const pistolModel = document.querySelector('#pistol-model-b');
          const pistolLight = document.querySelector('#pistol-light');
          const pistolHitbox = document.querySelector('#pistol-hitbox');
          
          if (!pistolContainer || !pistolModel) {
            console.warn('Pistolet non trouv√©');
            return;
          }
          
          // Retirer la classe clickable
          if (pistolHitbox) pistolHitbox.classList.remove('clickable');
          
          // Intensifier la lumi√®re
          if (pistolLight) {
            pistolLight.setAttribute('animation__glow', {
              property: 'intensity',
              to: 1.5,
              dur: 1000,
              easing: 'easeOutQuad'
            });
          }
          
          // Animation de l√©vitation (le conteneur monte)
          pistolContainer.setAttribute('animation__levitate', {
            property: 'position',
            to: '-0.6 1.4 -0.8',
            dur: 2000,
            easing: 'easeOutCubic'
          });
          
          // Animation de redressement (le mod√®le se redresse)
          pistolModel.setAttribute('animation__straighten', {
            property: 'rotation',
            to: '0 0 0',
            dur: 1500,
            easing: 'easeOutBack'
          });
          
          // Animation de rotation infinie (apr√®s le redressement)
          setTimeout(() => {
            pistolModel.setAttribute('animation__spin', {
              property: 'rotation',
              from: '0 0 0',
              to: '0 360 0',
              dur: 3000,
              loop: true,
              easing: 'linear'
            });
            
            // Ajouter une l√©g√®re oscillation verticale
            pistolContainer.setAttribute('animation__float', {
              property: 'position',
              from: '-0.6 1.4 -0.8',
              to: '-0.6 1.5 -0.8',
              dur: 2000,
              dir: 'alternate',
              loop: true,
              easing: 'easeInOutSine'
            });
            
            updateDebug('üî´ L√©vitation activ√©e');
            
            // ====== SON DU PISTOLET + RETOUR SC√àNE A ======
            setTimeout(() => {
              // Jouer le son du pistolet
              if (gunSound) {
                gunSound.volume = 0.8;
                gunSound.play().then(() => {
                  updateDebug('üí• BANG !');
                }).catch(err => console.warn('Audio pistolet bloqu√©:', err));
              }
              
              // Flash blanc
              blackOut.setAttribute('material', 'color', '#FFFFFF');
              blackOut.setAttribute('visible', 'true');
              blackOut.setAttribute('animation__flash', {
                property: 'material.opacity',
                from: 0,
                to: 1,
                dur: 100,
                easing: 'easeInQuad'
              });
              
              // Transition retour vers sc√®ne A
              setTimeout(() => {
                // Fondu au noir
                blackOut.setAttribute('material', 'color', '#000000');
                blackOut.setAttribute('animation__fadeBlack', {
                  property: 'material.opacity',
                  from: 1,
                  to: 1,
                  dur: 500
                });
                
                setTimeout(() => {
                  // Remettre sc√®ne A
                  sceneB.setAttribute('visible', 'false');
                  sceneA.setAttribute('visible', 'true');
                  
                  // R√©initialiser les murs et sol
                  room.setAttribute('material', {
                    color: '#1a0a0a',
                    metalness: 0.3,
                    roughness: 0.7,
                    side: 'back'
                  });
                  
                  floor.setAttribute('material', {
                    color: '#111',
                    metalness: 0.5,
                    roughness: 0.5
                  });
                  
                  // Repositionner le joueur
                  document.querySelector('#rig').object3D.position.set(0, 0, 0);
                  
                  // ====== R√âINITIALISER TOUS LES √âTATS ======
                  globalTransitionDone = false;
                  globalPistolActivated = false;
                  globalKeyActivated = false;
                  
                  // R√©activer la hitbox du milkshake
                  milkshakeHitbox.classList.add('clickable');
                  
                  // R√©initialiser le pistolet (position et rotation)
                  const pistolContainerReset = document.querySelector('#pistol-container');
                  const pistolModelReset = document.querySelector('#pistol-model-b');
                  const pistolHitboxReset = document.querySelector('#pistol-hitbox');
                  const pistolLightReset = document.querySelector('#pistol-light');
                  
                  if (pistolContainerReset) {
                    pistolContainerReset.removeAttribute('animation__levitate');
                    pistolContainerReset.removeAttribute('animation__float');
                    pistolContainerReset.setAttribute('position', '-0.6 0.6 -0.8');
                  }
                  if (pistolModelReset) {
                    pistolModelReset.removeAttribute('animation__straighten');
                    pistolModelReset.removeAttribute('animation__spin');
                    pistolModelReset.setAttribute('rotation', '90 -215.700 0');
                  }
                  if (pistolHitboxReset) {
                    pistolHitboxReset.classList.add('clickable');
                    pistolHitboxReset.setAttribute('position', '0 0.2 0.1');
                  }
                  if (pistolLightReset) {
                    pistolLightReset.removeAttribute('animation__glow');
                    pistolLightReset.setAttribute('intensity', '0.3');
                  }
                  
                  // R√©initialiser la cl√© (position et rotation)
                  const keyContainerReset = document.querySelector('#key-container');
                  const keyModelReset = document.querySelector('#key-model');
                  const keyHitboxReset = document.querySelector('#key-hitbox');
                  const keyLightReset = document.querySelector('#key-light');
                  
                  if (keyContainerReset) {
                    keyContainerReset.removeAttribute('animation__levitate');
                    keyContainerReset.removeAttribute('animation__float');
                    keyContainerReset.setAttribute('position', '0.7 0.6 -0.8');
                  }
                  if (keyModelReset) {
                    keyModelReset.removeAttribute('animation__straighten');
                    keyModelReset.removeAttribute('animation__spin');
                    keyModelReset.setAttribute('rotation', '90 0 0');
                  }
                  if (keyHitboxReset) {
                    keyHitboxReset.classList.add('clickable');
                    keyHitboxReset.setAttribute('position', '0 0.2 0.1');
                  }
                  if (keyLightReset) {
                    keyLightReset.removeAttribute('animation__glow');
                    keyLightReset.setAttribute('intensity', '0.5');
                  }
                  
                  // R√©initialiser le texte myst√®re
                  mysteryText.removeAttribute('animation__appear');
                  mysteryText.setAttribute('opacity', '0');
                  
                  // Relancer la musique
                  music.volume = musicVolume;
                  music.currentTime = 0;
                  music.play().catch(e => console.warn('Audio:', e));
                  
                  updateDebug('üéµ Retour Jack Rabbit Slim\'s');
                  if (instructions) instructions.innerHTML = 'Cliquez sur le $5 Shake';
                  
                  // Fondu sortie
                  setTimeout(() => {
                    blackOut.setAttribute('animation__fadeOut2', {
                      property: 'material.opacity',
                      from: 1,
                      to: 0,
                      dur: 1500,
                      easing: 'easeOutCubic'
                    });
                    
                    setTimeout(() => {
                      blackOut.setAttribute('visible', 'false');
                      updateDebug('‚úÖ Exp√©rience r√©initialis√©e');
                      updateDebug('üëÜ Pointez le shake');
                    }, 1600);
                  }, 200);
                }, 800);
              }, 300);
            }, 1000); // D√©lai r√©duit - son pistolet plus t√¥t
            
          }, 1500);
        }

        // ====== CL√â DOR√âE INTERACTIVE - SC√àNE B ======
        function activateKey() {
          if (globalKeyActivated) return;
          globalKeyActivated = true;
          
          updateDebug('üîë Cl√© activ√©e !');
          
          const keyContainer = document.querySelector('#key-container');
          const keyModel = document.querySelector('#key-model');
          const keyLight = document.querySelector('#key-light');
          const keyHitbox = document.querySelector('#key-hitbox');
          
          if (!keyContainer || !keyModel) {
            console.warn('Cl√© non trouv√©e');
            return;
          }
          
          // Retirer la classe clickable
          if (keyHitbox) keyHitbox.classList.remove('clickable');
          
          // Intensifier la lumi√®re
          if (keyLight) {
            keyLight.setAttribute('animation__glow', {
              property: 'intensity',
              to: 2,
              dur: 1000,
              easing: 'easeOutQuad'
            });
          }
          
          // Animation de l√©vitation (le conteneur monte)
          keyContainer.setAttribute('animation__levitate', {
            property: 'position',
            to: '0.6 1.4 -0.8',
            dur: 2000,
            easing: 'easeOutCubic'
          });
          
          // Animation de redressement (le mod√®le se redresse)
          keyModel.setAttribute('animation__straighten', {
            property: 'rotation',
            to: '0 0 0',
            dur: 1500,
            easing: 'easeOutBack'
          });
          
          // Animation de rotation infinie (apr√®s le redressement)
          setTimeout(() => {
            keyModel.setAttribute('animation__spin', {
              property: 'rotation',
              from: '0 0 0',
              to: '0 360 0',
              dur: 4000,
              loop: true,
              easing: 'linear'
            });
            
            // Ajouter une l√©g√®re oscillation verticale
            keyContainer.setAttribute('animation__float', {
              property: 'position',
              from: '0.6 1.4 -0.8',
              to: '0.6 1.5 -0.8',
              dur: 2500,
              dir: 'alternate',
              loop: true,
              easing: 'easeInOutSine'
            });
            
            updateDebug('üîë L√©vitation activ√©e');
            
            // ====== TRANSITION VERS √âCRAN FINAL CHANEL (fix√© √† la cam√©ra) ======
            setTimeout(() => {
              updateDebug('‚ú® The Golden Key...');
              
              // Fondu au blanc
              blackOut.setAttribute('material', 'color', '#FFFFFF');
              blackOut.setAttribute('visible', 'true');
              blackOut.setAttribute('animation__fadeWhite', {
                property: 'material.opacity',
                from: 0,
                to: 1,
                dur: 2000,
                easing: 'easeInOutQuad'
              });
              
              // Afficher l'√©cran Chanel fix√© √† la cam√©ra
              setTimeout(() => {
                // Cacher sc√®ne B
                sceneB.setAttribute('visible', 'false');
                
                // Afficher l'√©cran Chanel (fix√© √† la cam√©ra)
                const chanelScreen = document.querySelector('#chanel-screen');
                chanelScreen.setAttribute('visible', 'true');
                
                // Changer le fond en blanc (pour l'ambiance)
                room.setAttribute('material', {
                  color: '#FFFFFF',
                  shader: 'flat',
                  side: 'back'
                });
                floor.setAttribute('material', {
                  color: '#FFFFFF',
                  shader: 'flat'
                });
                
                // Cacher les √©l√©ments UI HTML
                document.getElementById('debug').style.display = 'none';
                document.getElementById('instructions').style.display = 'none';
                document.getElementById('title').style.display = 'none';
                
                // Fondu sortie du blanc
                setTimeout(() => {
                  blackOut.setAttribute('animation__fadeOutWhite', {
                    property: 'material.opacity',
                    from: 1,
                    to: 0,
                    dur: 1500,
                    easing: 'easeOutCubic'
                  });
                  
                  setTimeout(() => {
                    blackOut.setAttribute('visible', 'false');
                    updateDebug('üèÜ Fin - √âcran Chanel VR');
                  }, 1600);
                }, 300);
              }, 2000);
            }, 2500); // D√©lai apr√®s le d√©but de la rotation
            
          }, 1500);
        }

        // Clic sur le pistolet (hitbox)
        const pistolHitbox = document.querySelector('#pistol-hitbox');
        if (pistolHitbox) {
          pistolHitbox.addEventListener('click', () => {
            updateDebug('üî´ Clic pistolet');
            activatePistol();
          });
        }

        // Clic sur la cl√© (hitbox)
        const keyHitbox = document.querySelector('#key-hitbox');
        if (keyHitbox) {
          keyHitbox.addEventListener('click', () => {
            updateDebug('üîë Clic cl√©');
            activateKey();
          });
        }

        // Clic sur le bouton restart (sc√®ne C)
        const restartHitbox = document.querySelector('#restart-hitbox');
        if (restartHitbox) {
          restartHitbox.addEventListener('click', () => {
            updateDebug('üîÑ Restart cliqu√©');
            resetExperience();
          });
        }

        // Milkshake click
        milkshakeHitbox.addEventListener('click', () => {
          updateDebug('ü•§ Click direct hitbox');
          transitionToSceneB();
        });

        if (desktopCursor) {
          desktopCursor.addEventListener('click', (evt) => {
            const intersectedEl = evt.detail?.intersectedEl;
            
            // V√©rifier milkshake
            if (!globalTransitionDone && intersectedEl && intersectedEl.id === 'milkshake-hitbox') {
              transitionToSceneB();
            }
            
            // V√©rifier pistolet
            if (!globalPistolActivated && intersectedEl && intersectedEl.id === 'pistol-hitbox') {
              activatePistol();
            }
            
            // V√©rifier cl√©
            if (!globalKeyActivated && intersectedEl && intersectedEl.id === 'key-hitbox') {
              activateKey();
            }
            
            // V√©rifier bouton restart
            if (intersectedEl && intersectedEl.id === 'restart-hitbox') {
              resetExperience();
            }
          });
        }

        document.addEventListener('click', (evt) => {
          if (document.getElementById('start-experience').style.display !== 'none') return;
          
          const cam = document.querySelector('#cam');
          if (cam && cam.components.raycaster) {
            const intersections = cam.components.raycaster.intersections;
            if (intersections && intersections.length > 0) {
              const hit = intersections[0].object.el;
              
              if (!globalTransitionDone && hit && hit.id === 'milkshake-hitbox') {
                transitionToSceneB();
              }
              
              if (!globalPistolActivated && hit && hit.id === 'pistol-hitbox') {
                activatePistol();
              }
              
              if (!globalKeyActivated && hit && hit.id === 'key-hitbox') {
                activateKey();
              }
              
              // Bouton restart
              if (hit && hit.id === 'restart-hitbox') {
                resetExperience();
              }
            }
          }
        });

        scene.addEventListener('enter-vr', () => {
          updateDebug('ü•Ω Mode VR activ√©');
          if (vrHelp) vrHelp.setAttribute('visible', 'true');
          document.querySelector('#desktop-cursor')?.setAttribute('visible', 'false');
          if (music.paused) {
            music.volume = musicVolume;
            music.play().catch(e => console.warn('Audio VR:', e));
          }
        });

        scene.addEventListener('exit-vr', () => {
          updateDebug('üñ•Ô∏è Mode Desktop');
          if (vrHelp) vrHelp.setAttribute('visible', 'false');
          document.querySelector('#desktop-cursor')?.setAttribute('visible', 'true');
        });

        updateDebug('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
        updateDebug('üëÜ Pointez le shake');
      });
    });
  </script>
</body>

</html>