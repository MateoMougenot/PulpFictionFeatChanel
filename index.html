<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Chanel x Pulp Fiction Experience</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #debug {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.85);
        color: #0f0;
        padding: 10px;
        font-family: monospace;
        font-size: 11px;
        z-index: 1000;
        max-width: 280px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #0f0;
      }
      #instructions {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 15px 30px;
        font-family: 'Helvetica Neue', sans-serif;
        font-size: 14px;
        border-radius: 0;
        border: 1px solid #FFD700;
        z-index: 1000;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      #title {
        position: fixed;
        top: 10px;
        right: 10px;
        color: #FFD700;
        font-family: 'Georgia', serif;
        font-size: 18px;
        font-style: italic;
        z-index: 1000;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      }
      #controls {
        position: fixed;
        bottom: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.6);
        color: #aaa;
        padding: 8px 15px;
        font-family: monospace;
        font-size: 11px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="debug">Initialisation...</div>
    <div id="controls">ZQSD / ‚Üê‚Üë‚Üì‚Üí : se d√©placer ‚Ä¢ Souris : regarder ‚Ä¢ VR : G√¢chette pour interagir</div>
    <div id="instructions">Cliquez sur le $5 Shake</div>
    <div id="title">CHANEL √ó Pulp Fiction</div>

    <a-scene vr-mode-ui="enabled: true">
      
      <a-assets>
        <a-asset-item id="couch-model" src="./assets/models/Couch.glb"></a-asset-item>
        <a-asset-item id="milkshake-model" src="./assets/models/Milkshake.glb"></a-asset-item>
        <a-asset-item id="speaker-model" src="./assets/models/Speaker.glb"></a-asset-item>
      </a-assets>

      <!-- ========== CAMERA RIG (Desktop + VR) ========== -->
      <a-entity id="rig" position="0 0 0"
                wasd-controls="acceleration: 20"
                constrain-position="min: -1.7 0 -1.7; max: 1.7 0 1.7">
        
        <!-- Cam√©ra -->
        <a-camera id="cam" position="0 1.6 0" look-controls="enabled: true; pointerLockEnabled: true">
          
          <!-- Curseur pour Desktop (cach√© en VR) -->
          <a-entity id="desktop-cursor"
                    cursor="fuse: false; rayOrigin: mouse"
                    raycaster="objects: .clickable; far: 10">
            <a-ring position="0 0 -1" radius-inner="0.02" radius-outer="0.03" color="#FFD700" opacity="0.8"
                    animation__scale="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dur: 500; dir: alternate; loop: true">
            </a-ring>
          </a-entity>
          
          <!-- Black-out pour transition -->
          <a-plane id="black-out" position="0 0 -0.3" width="6" height="6" 
                   material="color: #000; opacity: 0; transparent: true; shader: flat; side: double" visible="false">
          </a-plane>
        </a-camera>

        <!-- ========== MANETTE GAUCHE ========== -->
        <a-entity id="left-hand"
                  laser-controls="hand: left; model: true; defaultModelColor: #FFD700"
                  raycaster="objects: .clickable; far: 10; lineColor: #FFD700; lineOpacity: 0.5"
                  vr-click-handler>
        </a-entity>

        <!-- ========== MANETTE DROITE ========== -->
        <a-entity id="right-hand"
                  laser-controls="hand: right; model: true; defaultModelColor: #FFD700"
                  raycaster="objects: .clickable; far: 10; lineColor: #FFD700; lineOpacity: 0.5"
                  vr-click-handler>
        </a-entity>

      </a-entity>

      <!-- Cube 4x4x4 -->
      <a-box id="room" position="0 2 0" width="4" height="4" depth="4" 
             material="color: #1a0a0a; metalness: 0.3; roughness: 0.7; side: back"></a-box>

      <!-- Sol -->
      <a-plane id="floor" position="0 0.01 0" rotation="-90 0 0" width="4" height="4"
               material="color: #111; metalness: 0.5; roughness: 0.5"></a-plane>

      <!-- ========== SC√àNE A ========== -->
      <a-entity id="scene-a">
        
        <!-- DANCEFLOOR -->
        <a-entity id="dancefloor" position="0 0.02 0">
          <a-box position="-0.75 0 -0.75" width="0.5" height="0.02" depth="0.5" color="#111" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="-0.25 0 -0.75" width="0.5" height="0.02" depth="0.5" color="#EEE" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="0.25 0 -0.75" width="0.5" height="0.02" depth="0.5" color="#111" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="0.75 0 -0.75" width="0.5" height="0.02" depth="0.5" color="#EEE" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="-0.75 0 -0.25" width="0.5" height="0.02" depth="0.5" color="#EEE" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="-0.25 0 -0.25" width="0.5" height="0.02" depth="0.5" color="#111" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="0.25 0 -0.25" width="0.5" height="0.02" depth="0.5" color="#EEE" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="0.75 0 -0.25" width="0.5" height="0.02" depth="0.5" color="#111" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="-0.75 0 0.25" width="0.5" height="0.02" depth="0.5" color="#111" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="-0.25 0 0.25" width="0.5" height="0.02" depth="0.5" color="#EEE" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="0.25 0 0.25" width="0.5" height="0.02" depth="0.5" color="#111" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="0.75 0 0.25" width="0.5" height="0.02" depth="0.5" color="#EEE" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="-0.75 0 0.75" width="0.5" height="0.02" depth="0.5" color="#EEE" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="-0.25 0 0.75" width="0.5" height="0.02" depth="0.5" color="#111" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="0.25 0 0.75" width="0.5" height="0.02" depth="0.5" color="#EEE" material="metalness: 0.8; roughness: 0.2"></a-box>
          <a-box position="0.75 0 0.75" width="0.5" height="0.02" depth="0.5" color="#111" material="metalness: 0.8; roughness: 0.2"></a-box>
        </a-entity>

        <!-- COUCHS -->
        <a-entity gltf-model="#couch-model" position="-1.6 0.3 0" rotation="0 -90 0" scale="1.4 1.4 1.4"></a-entity>
        <a-entity gltf-model="#couch-model" position="1.6 0.3 0" rotation="0 90 0" scale="1.4 1.4 1.4"></a-entity>

        <!-- SPEAKERS -->
        <a-entity gltf-model="#speaker-model" position="-1.5 0 -1.5" rotation="0 45 0" scale="0.5 0.5 0.5"></a-entity>
        <a-entity gltf-model="#speaker-model" position="1.5 0 -1.5" rotation="0 -45 0" scale="1 1 1"></a-entity>

        <!-- TABLE -->
        <a-entity position="0 0 1.2">
          <a-cylinder radius="0.35" height="0.05" position="0 0.55 0" color="#222" material="metalness: 0.9; roughness: 0.1"></a-cylinder>
          <a-cylinder radius="0.04" height="0.55" position="0 0.275 0" color="#888" material="metalness: 0.9; roughness: 0.1"></a-cylinder>
        </a-entity>

        <!-- MILKSHAKE (mod√®le 3D) -->
        <a-entity id="trigger-milkshake" position="0 0.58 1.2">
          <a-entity id="milkshake-glb" gltf-model="#milkshake-model" position="0 0.2 0" scale="0.13 0.13 0.13"></a-entity>
          <a-light type="point" intensity="0.8" distance="2" color="#FFB6C1"></a-light>
          <a-text value="$5 SHAKE" position="0 0.5 0" align="center" scale="0.35 0.35 0.35" color="#FFD700" 
                  animation__float="property: position; from: 0 0.5 0; to: 0 0.55 0; dur: 1000; dir: alternate; loop: true"></a-text>
        </a-entity>

        <!-- HITBOX CLIQUABLE -->
        <a-box id="milkshake-hitbox" 
               class="clickable" 
               position="0 0.8 1.2" 
               width="0.5" height="0.6" depth="0.5"
               visible="false">
        </a-box>

        <!-- N√âONS -->
        <a-entity position="0 3.5 -1.95">
          <a-text value="JACK RABBIT SLIM'S" align="center" color="#FF1493" scale="0.35 0.35 0.35"></a-text>
          <a-light type="point" intensity="0.8" distance="3" color="#FF1493" position="0 0 0.1"></a-light>
        </a-entity>
        <a-entity position="-1.95 2.5 0" rotation="0 90 0">
          <a-text value="‚ô™ TWIST ‚ô™" align="center" color="#00CED1" scale="0.25 0.25 0.25"></a-text>
          <a-light type="point" intensity="0.5" distance="2" color="#00CED1"></a-light>
        </a-entity>
        <a-entity position="1.95 2.5 0" rotation="0 -90 0">
          <a-text value="‚òÖ 1950s ‚òÖ" align="center" color="#FFD700" scale="0.25 0.25 0.25"></a-text>
          <a-light type="point" intensity="0.5" distance="2" color="#FFD700"></a-light>
        </a-entity>

        <!-- PANNEAU D'AIDE VR -->
        <a-entity id="vr-help" position="0 2.5 1.5" rotation="0 180 0" visible="false">
          <a-plane width="1.2" height="0.4" color="#000" opacity="0.8"></a-plane>
          <a-text value="Pointez le milkshake\net appuyez sur la g√¢chette" 
                  position="0 0 0.01" align="center" color="#FFD700" scale="0.4 0.4 0.4" width="2.5"></a-text>
        </a-entity>

        <!-- √âCLAIRAGE -->
        <a-light type="ambient" color="#331111" intensity="0.4"></a-light>
        <a-light type="spot" position="0 3.9 0" rotation="-90 0 0" intensity="1.5" color="#FFFAF0" angle="50" penumbra="0.3"></a-light>
        <a-light type="point" position="-1.5 3 -1" intensity="0.6" color="#FF1493" distance="4"></a-light>
        <a-light type="point" position="1.5 3 -1" intensity="0.6" color="#00CED1" distance="4"></a-light>
        <a-light type="point" position="0 3 1.5" intensity="0.4" color="#FFD700" distance="3"></a-light>
      </a-entity>

      <!-- ========== SC√àNE B ========== -->
      <a-entity id="scene-b" visible="false">
        <a-entity id="briefcase" position="0 0.6 -1">
          <a-box width="0.8" height="0.12" depth="0.5" color="#1a1a1a" material="metalness: 0.8; roughness: 0.2">
            <a-box position="-0.28 0.07 0.26" width="0.06" height="0.015" depth="0.015" color="#D4AF37" material="metalness: 1; roughness: 0.1"></a-box>
            <a-box position="0.28 0.07 0.26" width="0.06" height="0.015" depth="0.015" color="#D4AF37" material="metalness: 1; roughness: 0.1"></a-box>
            <a-text value="CHANEL" position="0 0.065 0.251" align="center" color="#D4AF37" scale="0.06 0.06 0.06"></a-text>
          </a-box>
          <a-entity position="0 0.06 -0.25" rotation="-115 0 0">
            <a-box width="0.8" height="0.05" depth="0.5" position="0 0 0.25" color="#1a1a1a" material="metalness: 0.8; roughness: 0.2"></a-box>
          </a-entity>
          <a-box width="0.7" height="0.01" depth="0.4" position="0 0.065 0" material="color: #FFD700; shader: flat; emissive: #FFD700; emissiveIntensity: 8"></a-box>
          <a-light type="point" intensity="10" color="#FFD700" position="0 0.5 0" distance="12"
                   animation__pulse="property: intensity; from: 8; to: 14; dur: 2000; dir: alternate; loop: true"></a-light>
          <a-light type="point" intensity="3" color="#FFA500" position="0 0.2 0" distance="5"></a-light>
        </a-entity>
        <a-text id="mystery-text" value="What's in the box?" position="0 2.8 -1.5" align="center" color="#FFD700" scale="0.5 0.5 0.5" opacity="0"></a-text>
        <a-light type="ambient" color="#111" intensity="0.1"></a-light>
      </a-entity>

    </a-scene>

    <script>
      // ================================
      // COMPOSANT: Gestion des clics VR (manettes)
      // ================================
      AFRAME.registerComponent('vr-click-handler', {
        init: function () {
          const el = this.el;
          
          // G√¢chette (trigger)
          el.addEventListener('triggerdown', this.onClick.bind(this));
          
          // WebXR standard events
          el.addEventListener('selectstart', this.onClick.bind(this));
          
          // Changement de couleur au survol
          el.addEventListener('raycaster-intersection', (evt) => {
            const target = evt.detail.els[0];
            if (target && target.classList.contains('clickable')) {
              el.setAttribute('raycaster', 'lineColor', '#00FF00');
            }
          });
          
          el.addEventListener('raycaster-intersection-cleared', () => {
            el.setAttribute('raycaster', 'lineColor', '#FFD700');
          });
        },
        
        onClick: function () {
          const raycaster = this.el.components.raycaster;
          if (!raycaster) return;
          
          const intersections = raycaster.intersections;
          if (intersections.length > 0) {
            const target = intersections[0].object.el;
            if (target && target.classList.contains('clickable')) {
              target.emit('click');
              console.log('üéÆ VR Click on:', target.id);
            }
          }
        }
      });

      // ================================
      // COMPOSANT: Contraindre la position
      // ================================
      AFRAME.registerComponent('constrain-position', {
        schema: {
          min: { type: 'vec3', default: { x: -1.7, y: 0, z: -1.7 } },
          max: { type: 'vec3', default: { x: 1.7, y: 0, z: 1.7 } }
        },
        tick: function () {
          const pos = this.el.object3D.position;
          const min = this.data.min;
          const max = this.data.max;
          if (pos.x < min.x) pos.x = min.x;
          if (pos.x > max.x) pos.x = max.x;
          if (pos.z < min.z) pos.z = min.z;
          if (pos.z > max.z) pos.z = max.z;
          pos.y = 0;
        }
      });

      // ================================
      // DEBUG & LOGIQUE PRINCIPALE
      // ================================
      function updateDebug(msg) {
        const d = document.getElementById('debug');
        if (d) { d.innerHTML += `<br>${msg}`; d.scrollTop = d.scrollHeight; }
        console.log(msg);
      }

      document.addEventListener('DOMContentLoaded', () => {
        updateDebug('üé¨ Chanel x Pulp Fiction');
        updateDebug('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
        
        const scene = document.querySelector('a-scene');
        
        scene.addEventListener('loaded', () => {
          updateDebug('‚úÖ Sc√®ne charg√©e');
          updateDebug('üéÆ Desktop: ZQSD + clic');
          updateDebug('ü•Ω VR: G√¢chette');
          
          const milkshakeHitbox = document.querySelector('#milkshake-hitbox');
          const blackOut = document.querySelector('#black-out');
          const sceneA = document.querySelector('#scene-a');
          const sceneB = document.querySelector('#scene-b');
          const room = document.querySelector('#room');
          const floor = document.querySelector('#floor');
          const instructions = document.getElementById('instructions');
          const controls = document.getElementById('controls');
          const mysteryText = document.querySelector('#mystery-text');
          const vrHelp = document.querySelector('#vr-help');

          let transitionDone = false;

          // Clic sur la hitbox (fonctionne pour Desktop ET VR)
          milkshakeHitbox.addEventListener('click', () => {
            if (transitionDone) return;
            updateDebug('ü•§ $5 Shake cliqu√© !');
            transitionToSceneB();
          });

          function transitionToSceneB() {
            if (transitionDone) return;
            transitionDone = true;
            updateDebug('üéûÔ∏è CUT !');
            
            if (instructions) instructions.innerHTML = 'THE MYSTERY';
            if (controls) controls.style.display = 'none';
            milkshakeHitbox.classList.remove('clickable');

            blackOut.setAttribute('visible', 'true');
            blackOut.setAttribute('animation__fadeIn', { 
              property: 'material.opacity', from: 0, to: 1, dur: 200, easing: 'easeInQuad' 
            });

            setTimeout(() => {
              sceneA.setAttribute('visible', 'false');
              sceneB.setAttribute('visible', 'true');
              room.setAttribute('material', { color: '#050505', metalness: 0.95, roughness: 0.05, side: 'back' });
              floor.setAttribute('material', { color: '#030303', metalness: 0.9, roughness: 0.1 });
              document.querySelector('#rig').object3D.position.set(0, 0, 1);

              setTimeout(() => {
                blackOut.setAttribute('animation__fadeOut', { 
                  property: 'material.opacity', from: 1, to: 0, dur: 1500, easing: 'easeOutCubic' 
                });
                setTimeout(() => {
                  mysteryText.setAttribute('animation__appear', { property: 'opacity', from: 0, to: 0.9, dur: 2000 });
                }, 800);
                setTimeout(() => {
                  blackOut.setAttribute('visible', 'false');
                  updateDebug('‚úÖ R√©v√©lation');
                  updateDebug('üíº La Mallette...');
                }, 1600);
              }, 150);
            }, 250);
          }

          // Gestion du mode VR
          scene.addEventListener('enter-vr', () => {
            updateDebug('ü•Ω Mode VR activ√©');
            if (vrHelp) vrHelp.setAttribute('visible', 'true');
            const desktopCursor = document.querySelector('#desktop-cursor');
            if (desktopCursor) desktopCursor.setAttribute('visible', 'false');
          });
          
          scene.addEventListener('exit-vr', () => {
            updateDebug('üñ•Ô∏è Mode Desktop');
            if (vrHelp) vrHelp.setAttribute('visible', 'false');
            const desktopCursor = document.querySelector('#desktop-cursor');
            if (desktopCursor) desktopCursor.setAttribute('visible', 'true');
          });

          updateDebug('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
          updateDebug('üëÜ Pointez le shake');
        });
      });
    </script>
  </body>
</html>