<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pulp Fiction Experience</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #debug {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: #0f0;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        z-index: 1000;
        max-width: 300px;
      }
    </style>
  </head>
  <body>
    <div id="debug">Chargement...</div>

    <a-scene>
      
      <a-assets>
        <img id="dancer" src="https://cdn.pixabay.com/photo/2014/04/03/10/32/dancer-310890_1280.png" crossorigin="anonymous">
      </a-assets>

      <!-- CamÃ©ra avec mouvement libre Ã  la souris -->
      <a-entity id="rig" position="0 0 0" 
                wasd-controls="acceleration: 30">
        <a-camera id="cam" position="0 1.6 0">
          <a-cursor 
            id="cursor"
            color="#FF0000"
            raycaster="objects: .clickable; far: 10"
            fuse="false">
          </a-cursor>
          
          <!-- Rideau noir attachÃ© Ã  la camÃ©ra -->
          <a-plane id="black-out" position="0 0 -0.5" width="4" height="4" 
                   material="color: #000; opacity: 0; transparent: true; shader: flat; side: double" 
                   visible="false">
          </a-plane>
        </a-camera>
      </a-entity>

      <a-box id="room" position="0 2 0" width="4" height="4" depth="4" 
             material="color: #111; metalness: 0.2; roughness: 0.8; side: back">
      </a-box>

      <!-- SCÃˆNE A : Jack Rabbit Slim's -->
      <a-entity id="scene-a">
        <a-image src="#dancer" position="-0.8 1.2 -1.5" width="1.2" height="1.8" transparent="true"
                 animation="property: rotation; to: 0 20 5; dur: 1000; dir: alternate; loop: true"></a-image>
        <a-image src="#dancer" position="0.8 1.2 -1.5" width="1.2" height="1.8" transparent="true" scale="-1 1 1"
                 animation="property: rotation; to: 0 -20 -5; dur: 1100; dir: alternate; loop: true"></a-image>

        <!-- Milkshake AVEC GÃ‰OMÃ‰TRIE CLIQUABLE -->
        <a-entity id="trigger-milkshake" class="clickable" position="0 0.8 -1.2">
          <!-- Hitbox invisible plus grande -->
          <a-box class="clickable" width="0.3" height="0.5" depth="0.3" 
                 material="opacity: 0; transparent: true"></a-box>
          
          <a-cylinder radius="0.1" height="0.3" color="#FFB6C1"></a-cylinder>
          <a-cone radius-bottom="0.1" radius-top="0.02" height="0.1" position="0 0.2 0" color="#FFF"></a-cone>
          <a-light type="point" intensity="0.5" distance="2" color="#FFB6C1"></a-light>
          
          <a-text value="$5 SHAKE\nCLICK ME" position="0 0.6 0" align="center" 
                  scale="0.4 0.4 0.4" color="#FFF" width="2"></a-text>
        </a-entity>

        <a-light type="ambient" color="#555" intensity="0.8"></a-light>
        <a-light type="spot" position="0 3.8 -1.5" rotation="-90 0 0" intensity="1.2" color="#FFF"></a-light>
      </a-entity>

      <!-- SCÃˆNE B : La Mallette -->
      <a-entity id="scene-b" visible="false">
        <a-entity id="briefcase" position="0 0.1 -1.5">
          <!-- Base de la mallette (partie fixe) -->
          <a-box id="briefcase-bottom" width="0.8" height="0.1" depth="0.5" color="#4a4a4a"
                 material="metalness: 0.6; roughness: 0.4"></a-box>
          
          <!-- CharniÃ¨re (point de pivot au fond de la mallette) -->
          <a-entity id="briefcase-hinge" position="0 0.05 -0.25">
            <!-- Couvercle qui pivote autour de la charniÃ¨re -->
            <a-box id="briefcase-lid" 
                   width="0.8" height="0.05" depth="0.5" 
                   position="0 0 0.25" 
                   rotation="0 0 0"
                   color="#555"
                   material="metalness: 0.6; roughness: 0.4">
            </a-box>
          </a-entity>
          
          <!-- LumiÃ¨re dorÃ©e (invisible au dÃ©but, apparaÃ®t Ã  l'ouverture) -->
          <a-light id="golden-light" type="point" intensity="0" color="#FFD700" position="0 0.2 0" distance="8"></a-light>
          
          <!-- IntÃ©rieur lumineux (invisible au dÃ©but) -->
          <a-box id="golden-interior" width="0.6" height="0.01" depth="0.3" position="0 0.06 0" 
                 material="color: #FFD700; shader: flat; emissive: #FFD700; emissiveIntensity: 0; opacity: 0; transparent: true"></a-box>
        </a-entity>

        <!-- LUMIÃˆRES AMBIANTES POUR VOIR LA SCÃˆNE -->
        <a-light type="ambient" color="#888" intensity="1.5"></a-light>
        <a-light type="directional" position="2 4 2" intensity="1.2" color="#aaa"></a-light>
        <a-light type="point" position="0 2 0" intensity="1.5" color="#999" distance="8"></a-light>
        <a-light type="point" position="-2 2 -2" intensity="0.8" color="#777" distance="6"></a-light>
        
        <a-text id="mystery-text" value="" position="0 1.8 -2" align="center" color="#FFD700" scale="0.8 0.8 0.8"></a-text>
      </a-entity>

    </a-scene>

    <script>
      // Composant mouse-look SIMPLE qui fonctionne
      AFRAME.registerComponent('mouse-look', {
        schema: { sensitivity: { default: 1.5 } },
        
        init: function() {
          this.yaw = 0;
          this.pitch = 0;
          this.onMouseMove = this.onMouseMove.bind(this);
          
          document.addEventListener('mousemove', this.onMouseMove);
          console.log('âœ… Mouse-look activÃ©');
        },

        onMouseMove: function(e) {
          if (!e.movementX && !e.movementY) return;
          
          this.yaw -= e.movementX * this.data.sensitivity * 0.002;
          this.pitch -= e.movementY * this.data.sensitivity * 0.002;
          this.pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, this.pitch));
        },

        tick: function() {
          if (!this.el || !this.el.object3D) return;
          
          const rotation = this.el.object3D.rotation;
          rotation.order = 'YXZ';
          rotation.y = this.yaw;
          rotation.x = this.pitch;
        },

        remove: function() {
          document.removeEventListener('mousemove', this.onMouseMove);
        }
      });

      function updateDebug(msg) {
        const d = document.getElementById('debug');
        if (d) d.innerHTML += '<br>' + msg;
        console.log(msg);
      }

      document.addEventListener('DOMContentLoaded', () => {
        updateDebug('DOM chargÃ©');
        
        const scene = document.querySelector('a-scene');
        
        scene.addEventListener('loaded', () => {
          updateDebug('âœ… ScÃ¨ne loaded');
          
          // Activer le mouse-look
          const camera = document.querySelector('#cam');
          camera.setAttribute('mouse-look', 'sensitivity: 1.5');
          
          const milkshake = document.querySelector('#trigger-milkshake');
          const blackOut = document.querySelector('#black-out');
          const sceneA = document.querySelector('#scene-a');
          const sceneB = document.querySelector('#scene-b');
          const room = document.querySelector('#room');
          const cursor = document.querySelector('#cursor');

          if (!milkshake) {
            updateDebug('âŒ Milkshake introuvable');
            return;
          }

          updateDebug('âœ… Milkshake trouvÃ©');

          let transitionDone = false; // FLAG pour empÃªcher la double transition

          // MÃ‰THODE 1: Via le curseur A-Frame
          cursor.addEventListener('click', (evt) => {
            if (transitionDone) {
              updateDebug('âš ï¸ Transition dÃ©jÃ  effectuÃ©e');
              return;
            }
            
            updateDebug('ðŸ–±ï¸ Curseur cliquÃ©');
            const intersected = evt.detail.intersection;
            if (intersected) {
              let el = intersected.object.el;
              while (el && !el.classList.contains('clickable')) {
                el = el.parentNode?.el;
              }
              if (el && el.id === 'trigger-milkshake') {
                updateDebug('ðŸŽ¬ MILKSHAKE CLIQUÃ‰ !');
                transitionToSceneB();
              }
            }
          });

          // MÃ‰THODE 2: Directement sur l'entitÃ©
          milkshake.addEventListener('click', () => {
            if (transitionDone) {
              updateDebug('âš ï¸ Transition dÃ©jÃ  effectuÃ©e');
              return;
            }
            updateDebug('ðŸŽ¬ MILKSHAKE EVENT !');
            transitionToSceneB();
          });

          function transitionToSceneB() {
            if (transitionDone) return; // Double sÃ©curitÃ©
            transitionDone = true;
            
            updateDebug('ðŸŽžï¸ Transition START');

            // DÃ‰SACTIVER le milkshake immÃ©diatement
            milkshake.classList.remove('clickable');
            milkshake.setAttribute('visible', 'false');

            blackOut.setAttribute('visible', 'true');
            blackOut.setAttribute('animation', {
              property: 'material.opacity',
              from: 0,
              to: 1,
              dur: 400,
              easing: 'easeInQuad'
            });

            setTimeout(() => {
              updateDebug('ðŸ”„ Swap scÃ¨nes');
              
              sceneA.setAttribute('visible', 'false');
              sceneB.setAttribute('visible', 'true');
              
              room.setAttribute('material', {
                color: '#1a1a1a',
                metalness: 0.5,
                roughness: 0.5,
                side: 'back'
              });

              setTimeout(() => {
                blackOut.setAttribute('animation', {
                  property: 'material.opacity',
                  from: 1,
                  to: 0,
                  dur: 1000,
                  easing: 'easeOutQuad'
                });

                setTimeout(() => {
                  blackOut.setAttribute('visible', 'false');
                  updateDebug('âœ… Transition DONE');
                  
                  // DÃ‰CLENCHER L'ANIMATION D'OUVERTURE
                  setTimeout(() => {
                    openBriefcase();
                  }, 500);
                }, 1000);
              }, 100);

            }, 400);
          }

          function openBriefcase() {
            updateDebug('ðŸ’¼ Ouverture de la mallette...');
            
            const hinge = document.querySelector('#briefcase-hinge');
            const goldenLight = document.querySelector('#golden-light');
            const goldenInterior = document.querySelector('#golden-interior');
            const mysteryText = document.querySelector('#mystery-text');
            
            // 1. Animation de la charniÃ¨re (rotation de 0Â° Ã  -120Â°)
            hinge.setAttribute('animation__open', {
              property: 'rotation',
              from: '0 0 0',
              to: '-120 0 0',
              dur: 2000,
              easing: 'easeInOutCubic'
            });
            
            // 2. Apparition progressive de la lumiÃ¨re dorÃ©e
            setTimeout(() => {
              goldenLight.setAttribute('animation__intensity', {
                property: 'intensity',
                from: 0,
                to: 10,
                dur: 1500,
                easing: 'easeOutQuad'
              });
              
              goldenLight.setAttribute('animation__pulse', {
                property: 'intensity',
                from: 8,
                to: 12,
                dur: 1000,
                dir: 'alternate',
                loop: true,
                delay: 1500
              });
              
              // 3. IntÃ©rieur lumineux devient visible
              goldenInterior.setAttribute('animation__opacity', {
                property: 'material.opacity',
                from: 0,
                to: 1,
                dur: 1000,
                easing: 'easeInQuad'
              });
              
              goldenInterior.setAttribute('animation__emissive', {
                property: 'material.emissiveIntensity',
                from: 0,
                to: 8,
                dur: 1000,
                easing: 'easeInQuad'
              });
              
              updateDebug('ðŸ’¡ LumiÃ¨re dorÃ©e activÃ©e');
              
            }, 800);
            
            // 4. Texte apparaÃ®t aprÃ¨s l'ouverture complÃ¨te
            setTimeout(() => {
              mysteryText.setAttribute('value', "What's in the box?");
              mysteryText.setAttribute('animation__fade', {
                property: 'material.opacity',
                from: 0,
                to: 1,
                dur: 1500
              });
              updateDebug('âœ… Mallette ouverte !');
              updateDebug('âœ… CamÃ©ra devrait Ãªtre libre');
            }, 2500);
          }
        });
      });
    </script>
  </body>
</html>